<!-- 
=============================================================================
MANAGE_USERS.HTML - GESTI√ìN DE USUARIOS DEL SISTEMA
=============================================================================

PROP√ìSITO:
Template para administraci√≥n de usuarios con control de acceso granular.
Solo accesible por usuarios con rol 'admin', implementa CRUD de usuarios
con medidas de seguridad avanzadas.

CARACTER√çSTICAS PRINCIPALES:
- Lista de usuarios existentes con roles diferenciados
- Formulario de creaci√≥n de nuevos usuarios
- Sistema de protecci√≥n anti-eliminaci√≥n accidental
- Validaci√≥n de permisos basada en roles
- Interfaz de grid responsive para desktop y m√≥vil

PATRONES JINJA2 AVANZADOS:
- Condicionales complejas para seguridad
- Loops con else para estados vac√≠os
- Comparaciones de IDs de sesi√≥n
- Badges din√°micos por roles
- Formularios con acciones espec√≠ficas

SEGURIDAD IMPLEMENTADA:
- Protecci√≥n contra auto-eliminaci√≥n
- Prevenci√≥n de eliminaci√≥n entre admins
- Confirmaci√≥n JavaScript para acciones destructivas
- Validaci√≥n de permisos a nivel de template
=============================================================================
-->

{% extends "layout.html" %}
<!-- 
HERENCIA DE LAYOUT BASE:
Aprovecha toda la funcionalidad del layout.html:
- Sistema de navegaci√≥n con control de roles
- Mensajes flash para feedback de operaciones
- CSS base y JavaScript compartido
- Header con informaci√≥n del usuario actual
-->

{% block title %}Gestionar Usuarios - Sistema de Inventario{% endblock %}
<!-- 
T√çTULO ESPEC√çFICO:
Identifica claramente la funci√≥n administrativa.
√ötil para administradores que manejan m√∫ltiples pesta√±as.
-->

{% block head %}
    <!-- 
    CSS ESPEC√çFICO PARA GESTI√ìN DE USUARIOS:
    Estilos dedicados para:
    - Layout de grid para lista + formulario
    - Badges de roles con colores diferenciados
    - Tabla responsive para usuarios
    - Formulario de creaci√≥n estilizado
    - Estados de protecci√≥n visual (iconos de candado)
    -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/manage_users.css') }}">
{% endblock %}

{% block content %}
<!-- CONTENIDO PRINCIPAL DE GESTI√ìN DE USUARIOS -->

<div class="users-header">
    <!-- 
    HEADER DE LA SECCI√ìN:
    T√≠tulo principal que identifica la funcionalidad.
    √Årea para potenciales breadcrumbs o botones de acci√≥n global.
    -->
    <h2>Gesti√≥n de Usuarios</h2>
</div>

<div class="users-grid">
    <!-- 
    LAYOUT DE GRID RESPONSIVO:
    Dise√±o de dos columnas para desktop:
    - Izquierda: Lista de usuarios existentes
    - Derecha: Formulario de creaci√≥n + informaci√≥n
    
    En m√≥viles se apila verticalmente para mejor usabilidad.
    -->
    
    <!-- SECCI√ìN IZQUIERDA: LISTA DE USUARIOS -->
    <div class="users-list-section">
        <h3>Usuarios Registrados</h3>
        <!-- 
        T√çTULO DE SECCI√ìN:
        Identifica claramente el contenido de esta √°rea.
        -->
        
        <div class="users-table-container">
        <!-- 
        CONTENEDOR CON SCROLL:
        Permite scroll horizontal en m√≥viles si la tabla es muy ancha.
        Mantiene headers visibles durante scroll vertical.
        -->
            <table class="users-table">
                <thead>
                    <tr>
                        <th>Usuario</th>
                        <th>Rol</th>
                        <th>Acciones</th>
                    </tr>
                    <!-- 
                    HEADERS DE TABLA:
                    - Usuario: Nombre de login del usuario
                    - Rol: Badge visual con permisos
                    - Acciones: Botones de eliminaci√≥n (con restricciones)
                    -->
                </thead>
                <tbody>
                    {% for user in users %}
                    <!-- 
                    LOOP POR TODOS LOS USUARIOS:
                    Itera sobre la lista de usuarios proporcionada por Flask.
                    Cada 'user' es un diccionario con keys: id, username, role
                    -->
                    <tr>
                        <td>{{ user['username'] }}</td>
                        <!-- 
                        NOMBRE DE USUARIO:
                        Acceso directo al diccionario user['username'].
                        Muestra el nombre de login sin escapar caracteres especiales.
                        -->
                        
                        <td>
                            <span class="role-badge role-{{ user['role'] }}">
                                {{ user['role'].title() }}
                            </span>
                            <!-- 
                            BADGE DE ROL DIN√ÅMICO:
                            
                            CLASES CSS GENERADAS:
                            - "role-badge role-admin" para administradores
                            - "role-badge role-editor" para editores
                            - "role-badge role-viewer" para visualizadores
                            
                            TEXTO FORMATEADO:
                            user['role'].title() convierte:
                            - "admin" ‚Üí "Admin"
                            - "editor" ‚Üí "Editor"
                            - "viewer" ‚Üí "Viewer"
                            
                            RESULTADO: Badges visualmente diferenciados por color seg√∫n CSS.
                            -->
                        </td>
                        
                        <td>
                            <!-- L√ìGICA COMPLEJA DE ACCIONES CON SEGURIDAD -->
                            {% if user['id'] == session.user_id %}
                            <!-- 
                            PROTECCI√ìN CONTRA AUTO-ELIMINACI√ìN:
                            Compara ID del usuario en la fila con ID de sesi√≥n actual.
                            Previene que usuarios se eliminen a s√≠ mismos accidentalmente.
                            -->
                                <span class="current-user-text">Tu cuenta</span>
                                <!-- 
                                INDICADOR VISUAL:
                                Texto plano que identifica la cuenta actual.
                                Sin botones destructivos para prevenir auto-eliminaci√≥n.
                                -->
                            {% elif user['role'] == 'admin' %}
                            <!-- 
                            PROTECCI√ìN ENTRE ADMINISTRADORES:
                            Otros admins no pueden eliminarse entre s√≠.
                            Medida de seguridad contra escalada de privilegios maliciosa.
                            -->
                                <span class="protected-user-text" title="Los administradores no pueden eliminarse entre s√≠ por seguridad">
                                    üîí Protegido
                                </span>
                                <!-- 
                                TOOLTIP EXPLICATIVO:
                                'title' muestra mensaje al hacer hover.
                                Explica por qu√© no se puede eliminar este usuario.
                                Icono de candado refuerza visualmente la protecci√≥n.
                                -->
                            {% else %}
                            <!-- 
                            USUARIOS ELIMINABLES:
                            Solo editores y viewers pueden ser eliminados por admins.
                            Implementa el principio de menor privilegio.
                            -->
                                <a href="{{ url_for('delete_user', user_id=user['id']) }}" 
                                   class="btn btn-danger delete-btn" 
                                   onclick="return confirm('¬øEst√°s seguro de eliminar este usuario?')">
                                    Eliminar
                                </a>
                                <!-- 
                                ENLACE DESTRUCTIVO CON PROTECCIONES:
                                
                                URL_FOR CON PAR√ÅMETRO:
                                Genera ruta como: /delete_user/123
                                Pasa user_id espec√≠fico para eliminaci√≥n
                                
                                CLASES CSS:
                                - btn: Estilo base de bot√≥n
                                - btn-danger: Color rojo para acci√≥n destructiva
                                - delete-btn: Estilos espec√≠ficos de eliminaci√≥n
                                
                                CONFIRMACI√ìN JAVASCRIPT:
                                onclick='return confirm(...)' muestra dialog nativo.
                                Si usuario cancela, return false previene navegaci√≥n.
                                Solo si acepta, procede con DELETE request.
                                -->
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <!-- 
                    ELSE DE LOOP - ESTADO SIN USUARIOS:
                    Se ejecuta cuando la lista 'users' est√° vac√≠a.
                    Escenario improbable pero importante para robustez.
                    -->
                    <tr>
                        <td colspan="3" class="no-users-message">
                            No hay usuarios registrados.
                        </td>
                        <!-- 
                        COLSPAN="3":
                        Expande la celda a trav√©s de las 3 columnas.
                        Centra visualmente el mensaje de estado vac√≠o.
                        
                        CLASE CSS ESPEC√çFICA:
                        'no-users-message' permite estilos especiales.
                        T√≠picamente texto gris, cursiva, centrado.
                        -->
                    </tr>
                    {% endfor %}
                    <!-- 
                    FIN DEL LOOP DE USUARIOS:
                    Ha iterado por todos los usuarios disponibles.
                    -->
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- SECCI√ìN DERECHA: FORMULARIO DE CREACI√ìN -->
    <div class="create-user-section">
        <h3>Crear Nuevo Usuario</h3>
        <!-- 
        T√çTULO DE SECCI√ìN DERECHA:
        Identifica la funcionalidad de creaci√≥n de usuarios.
        -->
        
        <div class="create-user-form">
        <!-- 
        CONTENEDOR DEL FORMULARIO:
        Wrapper para estilos espec√≠ficos del form de creaci√≥n.
        -->
            <form method="POST" action="{{ url_for('create_user') }}">
            <!-- 
            FORMULARIO DE CREACI√ìN CON ACTION ESPEC√çFICA:
            
            METHOD="POST":
            Env√≠a datos de forma segura en el cuerpo de la petici√≥n.
            
            ACTION EXPL√çCITA:
            url_for('create_user') dirige a endpoint espec√≠fico.
            Diferente del endpoint de la p√°gina actual (manage_users).
            
            RESULTADO: POST request va a /create_user en lugar de p√°gina actual.
            -->
                <div class="form-group">
                    <label for="username">Nombre de Usuario:</label>
                    <input type="text" id="username" name="username" required>
                    <!-- 
                    CAMPO NOMBRE DE USUARIO:
                    - TYPE="text": Texto simple sin restricciones especiales
                    - REQUIRED: Validaci√≥n HTML5 obligatoria
                    - NAME="username": Clave para request.form['username'] en Flask
                    -->
                </div>
                
                <div class="form-group">
                    <label for="password">Contrase√±a:</label>
                    <input type="password" id="password" name="password" required>
                    <!-- 
                    CAMPO CONTRASE√ëA:
                    - TYPE="password": Oculta caracteres visualmente
                    - REQUIRED: Obligatorio para creaci√≥n de cuenta
                    - Sin restricciones de longitud en frontend (validar en backend)
                    -->
                </div>
                
                <div class="form-group">
                    <label for="role">Rol:</label>
                    <select id="role" name="role" required>
                        <option value="">Seleccionar rol...</option>
                        <!-- 
                        OPCI√ìN POR DEFECTO VAC√çA:
                        Fuerza al admin a seleccionar expl√≠citamente un rol.
                        Previene asignaci√≥n accidental de permisos.
                        -->
                        <option value="admin">Administrador</option>
                        <option value="editor">Editor</option>
                        <option value="viewer">Visualizador</option>
                        <!-- 
                        OPCIONES DE ROLES:
                        Values corresponden exactamente con roles en base de datos.
                        Texto descriptivo para claridad del administrador.
                        -->
                    </select>
                    <!-- 
                    SELECT REQUERIDO:
                    REQUIRED attribute obliga selecci√≥n de rol v√°lido.
                    Opci√≥n vac√≠a inicial hace que sea obligatorio elegir.
                    -->
                </div>
                
                <button type="submit" class="btn btn-success create-user-btn">
                    Crear Usuario
                </button>
                <!-- 
                BOT√ìN DE ENV√çO:
                - TYPE="submit": Env√≠a formulario completo
                - btn-success: Color verde para acci√≥n positiva
                - create-user-btn: Clase espec√≠fica para estilos adicionales
                -->
            </form>
        </div>
        
        <!-- INFORMACI√ìN DE ROLES Y SEGURIDAD -->
        <div class="roles-info">
            <h4>Roles disponibles:</h4>
            <!-- 
            DOCUMENTACI√ìN DE ROLES:
            Informaci√≥n esencial para administradores que crean usuarios.
            Clarifica qu√© puede hacer cada tipo de usuario.
            -->
            <p><strong>Admin:</strong> Acceso completo al sistema</p>
            <p><strong>Editor:</strong> Puede ver y editar productos</p>  
            <p><strong>Viewer:</strong> Solo puede ver productos</p>
            <!-- 
            DESCRIPCI√ìN DE PERMISOS:
            - Admin: CRUD completo + gesti√≥n de usuarios
            - Editor: CRUD de productos, sin gesti√≥n de usuarios
            - Viewer: Solo lectura, no puede modificar nada
            
            PRINCIPIO DE MENOR PRIVILEGIO:
            Cada rol tiene solo los permisos m√≠nimos necesarios.
            -->
            
            <div class="security-info">
                <h4>üîí Medidas de Seguridad:</h4>
                <!-- 
                SECCI√ìN DE SEGURIDAD:
                Informa al administrador sobre las protecciones implementadas.
                Importante para transparencia y confianza en el sistema.
                -->
                <ul>
                    <li>Los administradores no pueden eliminarse entre s√≠</li>
                    <!-- 
                    PROTECCI√ìN ANTI-ESCALADA:
                    Previene que un admin rogue elimine otros admins.
                    Mantiene al menos un admin funcional en el sistema.
                    -->
                    <li>No puedes eliminar tu propia cuenta</li>
                    <!-- 
                    PROTECCI√ìN ANTI-AUTO-ELIMINACI√ìN:
                    Previene que administradores se bloqueen accidentalmente.
                    Requiere otro admin para eliminar cuentas de admin.
                    -->
                    <li>La sesi√≥n se cierra autom√°ticamente al cerrar/actualizar la p√°gina</li>
                    <!-- 
                    SEGURIDAD DE SESI√ìN:
                    Informa sobre comportamiento de logout autom√°tico.
                    Previene sesiones abiertas en equipos compartidos.
                    -->
                    <li>Logout autom√°tico silencioso despu√©s de 30 minutos de inactividad</li>
                    <!-- 
                    TIMEOUT DE SESI√ìN:
                    Pol√≠tica de expiraci√≥n por inactividad.
                    Balancea seguridad con experiencia de usuario.
                    -->
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

<!-- 
=============================================================================
RESUMEN T√âCNICO - MANAGE_USERS.HTML:
=============================================================================

PROP√ìSITO:
Template administrativo para gesti√≥n completa de usuarios del sistema.
Implementa CRUD de usuarios con medidas de seguridad avanzadas y control
de acceso granular basado en roles.

CARACTER√çSTICAS IMPLEMENTADAS:

1. INTERFAZ DE GESTI√ìN DUAL:
   - Lista de usuarios existentes con informaci√≥n de roles
   - Formulario de creaci√≥n para nuevos usuarios
   - Layout de grid responsive (desktop/m√≥vil)
   - Informaci√≥n contextual sobre permisos y seguridad

2. SISTEMA DE SEGURIDAD MULTINIVEL:
   - Protecci√≥n contra auto-eliminaci√≥n (session.user_id)
   - Prevenci√≥n de eliminaci√≥n entre administradores
   - Confirmaci√≥n JavaScript para acciones destructivas
   - Validaci√≥n de roles en formulario de creaci√≥n

3. GESTI√ìN DE ROLES AVANZADA:
   - Badges visuales diferenciados por tipo de usuario
   - Informaci√≥n clara de permisos para cada rol
   - Principio de menor privilegio aplicado
   - Documentaci√≥n integrada de capacidades

4. EXPERIENCIA DE USUARIO OPTIMIZADA:
   - Estados visuales claros (protegido, cuenta actual)
   - Tooltips explicativos para acciones restringidas
   - Mensajes informativos sobre pol√≠ticas de seguridad
   - Formulario con validaci√≥n requerida

5. INTEGRACI√ìN CON BACKEND:
   - Formulario con action espec√≠fica (create_user)
   - Enlaces de eliminaci√≥n con par√°metros de usuario
   - Aprovechamiento del sistema de mensajes flash
   - Manejo seguro de datos de sesi√≥n

PATRONES JINJA2 AVANZADOS UTILIZADOS:

- CONDICIONALES COMPLEJAS DE SEGURIDAD:
  if user['id'] == session.user_id (auto-protecci√≥n)
  elif user['role'] == 'admin' (protecci√≥n entre admins)
  else (usuarios eliminables)

- LOOPS CON ELSE PARA ROBUSTEZ:
  for user in users ... else (estado vac√≠o)

- BADGES DIN√ÅMICOS CON CLASES CSS:
  "role-badge role-" + user['role'] (estilos por rol)

- MANIPULACI√ìN DE STRINGS:
  user['role'].title() (formateo de texto)

- URL GENERATION CON PAR√ÅMETROS:
  url_for('delete_user', user_id=user['id'])

FLUJO DE OPERACIONES:

1. CARGA INICIAL:
   - Template recibe lista de usuarios de Flask
   - Renderiza tabla con informaci√≥n y controles
   - Muestra formulario de creaci√≥n vac√≠o

2. CREACI√ìN DE USUARIO:
   - Admin completa formulario (username, password, role)
   - POST a create_user endpoint espec√≠fico
   - Validaci√≥n backend y feedback via flash messages

3. ELIMINACI√ìN DE USUARIO:
   - Click en bot√≥n eliminar (solo para usuarios v√°lidos)
   - Confirmaci√≥n JavaScript obligatoria
   - GET request a delete_user con user_id espec√≠fico
   - Recarga p√°gina con usuario removido

MEDIDAS DE SEGURIDAD IMPLEMENTADAS:

- VALIDACI√ìN DE PERMISOS A NIVEL TEMPLATE:
  Solo admins ven esta p√°gina (controlado en layout.html)

- PROTECCI√ìN CONTRA ESCALADA DE PRIVILEGIOS:
  Admins no pueden eliminarse entre s√≠

- PREVENCI√ìN DE AUTO-LOCKOUT:
  Usuarios no pueden eliminar su propia cuenta

- CONFIRMACI√ìN DE ACCIONES DESTRUCTIVAS:
  JavaScript confirm() para eliminaciones

- PRINCIPIO DE MENOR PRIVILEGIO:
  Roles claramente definidos y diferenciados

CASOS DE USO PRINCIPALES:
- Onboarding de nuevos empleados al sistema
- Gesti√≥n de permisos y roles de usuarios existentes
- Offboarding seguro de usuarios que dejan la organizaci√≥n
- Auditor√≠a de usuarios activos y sus niveles de acceso
- Mantenimiento de pol√≠ticas de seguridad organizacional

DEPENDENCIAS T√âCNICAS:
- layout.html para estructura base y navegaci√≥n
- manage_users.css para estilos espec√≠ficos
- Sistema de roles Flask en backend
- Base de datos de usuarios con hash de contrase√±as
- Sistema de sesiones Flask para autenticaci√≥n
- JavaScript nativo para confirmaciones

CONSIDERACIONES DE ESCALABILIDAD:
- Tabla puede requerir paginaci√≥n con muchos usuarios
- Filtros de b√∫squeda para organizaciones grandes
- Bulk operations para gesti√≥n masiva de usuarios
- Integraci√≥n con sistemas externos de autenticaci√≥n (LDAP/OAuth)
=============================================================================
-->