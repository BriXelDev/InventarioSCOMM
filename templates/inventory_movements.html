<!-- 
PLANTILLA JINJA2 PARA HISTORIAL DE MOVIMIENTOS DE INVENTARIO

Este archivo implementa una vista avanzada de auditoria del sistema de inventario.
Es uno de los templates m√°s complejos porque maneja:

1. PAGINACI√ìN COMPLEJA: Sistema de p√°ginas con elipsis inteligentes
2. FILTROS M√öLTIPLES: Producto, tipo, fechas con preservaci√≥n de estado
3. C√ÅLCULOS MATEM√ÅTICOS: Rangos de registros, cambios de cantidad
4. HISTORIAL COMPLETO: Tracking de todas las operaciones del inventario
5. BADGES DIN√ÅMICOS: Visualizaci√≥n diferenciada por tipo de movimiento
6. NAVEGACI√ìN INTELIGENTE: URLs con m√∫ltiples par√°metros preservados

CARACTER√çSTICAS JINJA2 AVANZADAS:
- Loops con rangos matem√°ticos (range())
- Condicionales complejas anidadas
- C√°lculos inline para paginaci√≥n
- Preservaci√≥n de m√∫ltiples filtros en URLs
- Operaciones aritm√©ticas en templates
- Manejo de estados de datos opcionales

CASOS DE USO:
- Auditor√≠a de cambios en inventario
- Tracking de quien hizo qu√© y cu√°ndo
- An√°lisis de patrones de movimiento
- Debugging de discrepancias de stock
- Reportes hist√≥ricos para an√°lisis

TECNOLOG√çAS UTILIZADAS:
- Jinja2: Paginaci√≥n, filtros, c√°lculos matem√°ticos
- HTML5: Formularios de fecha, elementos sem√°nticos
- CSS Grid: Layout responsive para filtros y tabla
- JavaScript potencial: Filtros en tiempo real, exportaci√≥n
-->

{% extends "layout.html" %}
<!-- 
HERENCIA DE PLANTILLAS:
Utiliza la estructura base compartida, manteniendo consistencia
con el resto del sistema de inventario.
-->

{% block title %}Historial de Movimientos - Sistema de Inventario{% endblock %}
<!-- T√≠tulo espec√≠fico para la p√°gina de movimientos -->

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/inventory_movements.css') }}">
{% endblock %}
<!-- 
BLOQUE HEAD - CSS ESPEC√çFICO:
Los estilos de inventory_movements.css incluyen:
- Layout para secci√≥n de filtros complejos
- Estilos para badges de diferentes tipos de movimiento
- Paginaci√≥n responsiva con elipsis
- Tabla con columnas de diferentes anchos
- Estados visuales para cambios positivos/negativos
- Dise√±o de cards para filtros en m√≥viles
-->

{% block content %}
<!-- INICIO DEL CONTENIDO PRINCIPAL -->
<div class="movements-header">
    <!-- 
    HEADER DE MOVIMIENTOS CON CONTADOR:
    Combina t√≠tulo descriptivo con m√©tricas importantes.
    El contador total da contexto sobre el volumen de datos.
    -->
    <h2>üìã Historial de Movimientos de Inventario</h2>
    <div class="records-counter">
        <strong>Total de registros:</strong> {{ total_records }}
        <!-- 
        CONTADOR TOTAL DE REGISTROS:
        total_records viene de Flask con el conteo completo.
        No se ve afectado por filtros o paginaci√≥n.
        
        C√ÅLCULO EN BACKEND:
        SELECT COUNT(*) FROM inventory_movements
        
        UTILIDAD:
        - Proporciona contexto sobre el volumen de operaciones
        - Ayuda a usuarios a estimar tiempo de b√∫squeda
        - M√©trica de actividad del sistema
        -->
    </div>
</div>

<!-- SECCI√ìN DE FILTROS AVANZADOS -->
<div class="filters-section">
    <!-- 
    FILTROS M√öLTIPLES:
    Permite a usuarios refinar los resultados por varios criterios.
    Cada filtro se preserva en la navegaci√≥n y paginaci√≥n.
    -->
    <h3 class="filters-title">üîç Filtros</h3>
    <form method="GET" class="filters-form">
    <!-- 
    FORMULARIO GET PARA FILTROS:
    - method="GET": Par√°metros visibles en URL
    - Permite marcadores/compartir enlaces filtrados
    - Navegaci√≥n del navegador funciona correctamente
    - SEO friendly para b√∫squedas espec√≠ficas
    -->
        <div>
            <label for="product">Producto:</label>
            <input type="text" id="product" name="product" value="{{ product_filter or '' }}" 
                   placeholder="Buscar por producto..." class="filter-input">
            <!-- 
            FILTRO DE PRODUCTO CON PRESERVACI√ìN:
            value="{{ product_filter or '' }}"
            
            FUNCIONAMIENTO:
            1. Usuario escribe "Laptop Dell" y filtra
            2. URL: ?product=Laptop+Dell&movement_type=entrada
            3. Flask: product_filter = request.args.get('product')
            4. Template: value="Laptop Dell" (campo permanece lleno)
            5. Usuario puede refinar b√∫squeda sin perder contexto
            -->
        </div>
        
        <div>
            <label for="movement_type">Tipo de Movimiento:</label>
            <select id="movement_type" name="movement_type" class="filter-input">
                <option value="">Todos los tipos</option>
                <option value="entrada" {% if movement_type_filter == 'entrada' %}selected{% endif %}>Entrada</option>
                <option value="salida" {% if movement_type_filter == 'salida' %}selected{% endif %}>Salida</option>
                <option value="ajuste" {% if movement_type_filter == 'ajuste' %}selected{% endif %}>Ajuste</option>
                <option value="creacion" {% if movement_type_filter == 'creacion' %}selected{% endif %}>Creaci√≥n</option>
                <option value="eliminacion" {% if movement_type_filter == 'eliminacion' %}selected{% endif %}>Eliminaci√≥n</option>
            </select>
            <!-- 
            SELECT CON OPCIONES M√öLTIPLES Y PRESERVACI√ìN:
            
            OPCIONES DEL SISTEMA:
            - "entrada": Incremento de stock (compras, devoluciones)
            - "salida": Reducci√≥n de stock (ventas, consumo)  
            - "ajuste": Correcciones manuales de inventario
            - "creacion": Producto nuevo agregado al sistema
            - "eliminacion": Producto removido del sistema
            
            PRESERVACI√ìN DE SELECCI√ìN:
            {% if movement_type_filter == 'entrada' %}selected{% endif %}
            Cada option verifica si coincide con el filtro actual.
            Solo la opci√≥n correcta tendr√° el atributo "selected".
            -->
        </div>
        
        <div>
            <label for="date_from">Fecha desde:</label>
            <input type="date" id="date_from" name="date_from" value="{{ date_from or '' }}" class="filter-input">
            <!-- 
            INPUT DE FECHA HTML5:
            - type="date": Navegador muestra selector de fecha nativo
            - value="{{ date_from or '' }}": Preserva fecha seleccionada
            - Formato est√°ndar: YYYY-MM-DD
            
            CASOS DE USO:
            - Auditor√≠a de per√≠odo espec√≠fico
            - An√°lisis de actividad semanal/mensual
            - Investigaci√≥n de discrepancias en fechas conocidas
            - Reportes para contabilidad
            -->
        </div>
        
        <div>
            <label for="date_to">Fecha hasta:</label>
            <input type="date" id="date_to" name="date_to" value="{{ date_to or '' }}" class="filter-input">
            <!-- 
            FILTRO DE FECHA FINAL:
            Combinado con date_from permite rangos de fechas.
            Backend procesa: WHERE created_at BETWEEN date_from AND date_to
            -->
        </div>
        
        <div class="filter-actions">
            <!-- Contenedor para botones de acci√≥n de filtros -->
            <button type="submit" class="btn filter-btn">Filtrar</button>
            <!-- 
            BOT√ìN APLICAR FILTROS:
            - type="submit": Env√≠a formulario con todos los filtros
            - Genera URL con m√∫ltiples par√°metros
            - Ejemplo: ?product=laptop&movement_type=entrada&date_from=2024-01-01
            -->
            
            <a href="{{ url_for('inventory_movements') }}" class="btn clear-btn">Limpiar</a>
            <!-- 
            BOT√ìN LIMPIAR FILTROS:
            - url_for('inventory_movements'): URL base sin par√°metros
            - Efecto: remueve todos los filtros aplicados
            - Vuelve a mostrar todos los movimientos (paginados)
            -->
        </div>
    </form>
</div>

<!-- TABLA PRINCIPAL DE MOVIMIENTOS -->
<div class="movements-table-container">
    <!-- 
    CONTENEDOR CON SCROLL HORIZONTAL:
    Tabla compleja con muchas columnas que requiere scroll en m√≥viles.
    Mantiene headers fijos durante el scroll vertical.
    -->
    <table>
        <thead>
            <tr>
                <!-- 
                COLUMNAS DEL HISTORIAL:
                Dise√±adas para auditor√≠a completa de cada movimiento.
                Orden optimizado: temporal ‚Üí identificaci√≥n ‚Üí cambios ‚Üí contexto
                -->
                <th>Fecha</th>
                <th>Producto</th>
                <th>Tipo</th>
                <th>Cantidad Antes</th>
                <th>Cantidad Despu√©s</th>
                <th>Cambio</th>
                <th>Motivo</th>
                <th>Usuario</th>
            </tr>
        </thead>
        <tbody>
            {% for movement in movements %}
            <!-- 
            LOOP DE MOVIMIENTOS PAGINADOS:
            'movements' contiene solo los registros de la p√°gina actual.
            T√≠picamente 50 registros por p√°gina para performance √≥ptima.
            -->
            <tr>
                <td>{{ movement['created_at'] }}</td>
                <!-- Timestamp exacto del movimiento -->
                
                <td>{{ movement['product_name'] }}</td>
                <!-- Nombre del producto afectado -->
                
                <td>
                    {% if movement['movement_type'] == 'entrada' %}
                    <!-- 
                    BADGES DIFERENCIADOS POR TIPO:
                    Cada tipo de movimiento tiene su propio badge visual.
                    Permite identificaci√≥n r√°pida en listas largas.
                    -->
                        <span class="movement-badge movement-entrada">
                            ‚¨ÜÔ∏è Entrada
                        </span>
                    {% elif movement['movement_type'] == 'salida' %}
                        <span class="movement-badge movement-salida">
                            ‚¨áÔ∏è Salida
                        </span>
                    {% elif movement['movement_type'] == 'ajuste' %}
                        <span class="movement-badge movement-ajuste">
                            üîß Ajuste
                        </span>
                        <!-- 
                        BADGE DE AJUSTE:
                        Espec√≠fico para correcciones manuales de inventario.
                        Incluye tanto ajustes positivos como negativos.
                        -->
                    {% elif movement['movement_type'] == 'creacion' %}
                        <span class="movement-badge movement-creacion">
                            ‚ú® Creaci√≥n
                        </span>
                        <!-- 
                        BADGE DE CREACI√ìN:
                        Marca cuando un producto se agrega al sistema.
                        quantity_before ser√° 0, quantity_after ser√° inicial.
                        -->
                    {% elif movement['movement_type'] == 'eliminacion' %}
                        <span class="movement-badge movement-eliminacion">
                            üóëÔ∏è Eliminaci√≥n
                        </span>
                        <!-- 
                        BADGE DE ELIMINACI√ìN:
                        Marca cuando un producto se remueve del sistema.
                        quantity_after ser√° 0, registra stock final antes de eliminar.
                        -->
                    {% endif %}
                </td>
                <td>{{ movement['quantity_before'] }}</td>
                <!-- 
                CANTIDAD ANTES DEL MOVIMIENTO:
                Stock existente antes de aplicar el cambio.
                Crucial para auditor√≠a y verificaci√≥n de c√°lculos.
                -->
                
                <td>{{ movement['quantity_after'] }}</td>
                <!-- 
                CANTIDAD DESPU√âS DEL MOVIMIENTO:
                Stock resultante despu√©s de aplicar el cambio.
                Debe coincidir con quantity_before + quantity_change.
                -->
                
                <td>
                    {% if movement['quantity_change'] > 0 %}
                    <!-- 
                    VISUALIZACI√ìN DE CAMBIOS CON COLORES:
                    Diferentes estilos seg√∫n el tipo de cambio para reconocimiento visual r√°pido.
                    -->
                        <span class="quantity-positive">+{{ movement['quantity_change'] }}</span>
                        <!-- 
                        CAMBIO POSITIVO:
                        - Prefijo + expl√≠cito para claridad
                        - Color verde para indicar crecimiento
                        - Casos: entradas, ajustes al alza, correcciones positivas
                        -->
                    {% elif movement['quantity_change'] < 0 %}
                        <span class="quantity-negative">{{ movement['quantity_change'] }}</span>
                        <!-- 
                        CAMBIO NEGATIVO:
                        - El signo - ya est√° incluido en el n√∫mero
                        - Color rojo para indicar reducci√≥n
                        - Casos: salidas, ajustes a la baja, correcciones negativas
                        -->
                    {% else %}
                        <span class="quantity-neutral">0</span>
                        <!-- 
                        CAMBIO NEUTRO:
                        - Para movimientos que no afectan cantidad
                        - Casos: cambio de nombre, categor√≠a, precio
                        - Ediciones que no impactan stock f√≠sico
                        -->
                    {% endif %}
                </td>
                
                <td>{{ movement['reason'] or 'Sin motivo especificado' }}</td>
                <!-- 
                MOTIVO DEL MOVIMIENTO CON FALLBACK:
                movement['reason'] or 'Sin motivo especificado'
                
                MANEJO DE DATOS OPCIONALES:
                - Si reason existe y no est√° vac√≠o: muestra el motivo
                - Si reason es None o vac√≠o: muestra texto por defecto
                - Mejora la legibilidad evitando celdas vac√≠as
                
                EJEMPLOS DE MOTIVOS:
                - "Compra a proveedor XYZ"
                - "Venta al cliente ABC"
                - "Inventario f√≠sico - ajuste"
                - "Producto da√±ado - baja"
                - "Error de captura - correcci√≥n"
                -->
                
                <td>{{ movement['username'] }}</td>
                <!-- Usuario responsable del movimiento para accountability -->
            </tr>
            {% else %}
            <!-- 
            ELSE DE LOOP - ESTADO SIN RESULTADOS:
            Se ejecuta cuando no hay movimientos que mostrar.
            Puede ser por filtros restrictivos o falta de datos.
            -->
            <tr>
                <td colspan="8" class="no-movements">
                    No hay movimientos registrados con los filtros aplicados.
                </td>
                <!-- 
                MENSAJE ESPEC√çFICO PARA FILTROS:
                Indica que es problema de filtros, no falta de datos.
                colspan="8" hace que el mensaje ocupe toda la fila.
                -->
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- SISTEMA DE PAGINACI√ìN AVANZADO -->
{% if total_pages > 1 %}
<!-- 
PAGINACI√ìN CONDICIONAL:
Solo se muestra si hay m√°s de una p√°gina.
Evita elementos innecesarios en datasets peque√±os.
-->
<div class="pagination-container">
    {% if has_prev %}
    <!-- 
    BOT√ìN P√ÅGINA ANTERIOR:
    has_prev es un booleano calculado en Flask.
    Solo aparece si no estamos en la primera p√°gina.
    -->
        <a href="{{ url_for('inventory_movements', page=page-1, product=product_filter, movement_type=movement_type_filter, date_from=date_from, date_to=date_to) }}" 
           class="btn pagination-btn">‚Üê Anterior</a>
        <!-- 
        URL_FOR CON M√öLTIPLES PAR√ÅMETROS:
        Preserva TODOS los filtros aplicados al cambiar de p√°gina.
        
        PAR√ÅMETROS PRESERVADOS:
        - page=page-1: P√°gina anterior
        - product=product_filter: Filtro de producto
        - movement_type=movement_type_filter: Filtro de tipo
        - date_from=date_from: Filtro de fecha inicio
        - date_to=date_to: Filtro de fecha fin
        
        RESULTADO: Usuario mantiene filtros al navegar p√°ginas.
        -->
    {% endif %}
    
    {% for p in range(1, total_pages + 1) %}
    <!-- 
    LOOP PARA N√öMEROS DE P√ÅGINA:
    range(1, total_pages + 1) genera: [1, 2, 3, ..., total_pages]
    
    EJEMPLO:
    Si total_pages = 10: range(1, 11) = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
    -->
        {% if p == page %}
        <!-- P√ÅGINA ACTUAL: Sin enlace, solo indicador visual -->
            <span class="pagination-current">{{ p }}</span>
        {% elif p <= 3 or p >= total_pages - 2 or (p >= page - 1 and p <= page + 1) %}
        <!-- 
        L√ìGICA COMPLEJA DE PAGINACI√ìN CON ELIPSIS:
        
        CONDICIONES PARA MOSTRAR N√öMERO:
        1. p <= 3: Siempre muestra p√°ginas 1, 2, 3
        2. p >= total_pages - 2: Siempre muestra √∫ltimas 3 p√°ginas
        3. (p >= page - 1 and p <= page + 1): Muestra p√°gina actual ¬± 1
        
        EJEMPLO CON 15 P√ÅGINAS, P√ÅGINA ACTUAL = 8:
        Muestra: 1 2 3 ... 7 8 9 ... 13 14 15
        
        P√ÅGINAS MOSTRADAS:
        - 1, 2, 3 (condici√≥n 1)
        - 7, 8, 9 (condici√≥n 3: 8-1 <= p <= 8+1)
        - 13, 14, 15 (condici√≥n 2: p >= 15-2)
        -->
            <a href="{{ url_for('inventory_movements', page=p, product=product_filter, movement_type=movement_type_filter, date_from=date_from, date_to=date_to) }}" 
               class="btn pagination-page">{{ p }}</a>
        {% elif p == 4 and page > 5 %}
        <!-- 
        ELIPSIS IZQUIERDA:
        Se muestra cuando hay gap entre p√°ginas iniciales (1,2,3) y p√°gina actual.
        Solo si p√°gina actual > 5 para evitar elipsis innecesaria.
        -->
            <span class="pagination-ellipsis">...</span>
        {% elif p == total_pages - 3 and page < total_pages - 4 %}
        <!-- 
        ELIPSIS DERECHA:
        Se muestra cuando hay gap entre p√°gina actual y p√°ginas finales.
        Solo si hay suficiente distancia para justificar elipsis.
        -->
            <span class="pagination-ellipsis">...</span>
        {% endif %}
    {% endfor %}
    
    {% if has_next %}
    <!-- 
    BOT√ìN P√ÅGINA SIGUIENTE:
    has_next es calculado por Flask basado en registros restantes.
    Solo aparece si no estamos en la √∫ltima p√°gina.
    -->
        <a href="{{ url_for('inventory_movements', page=page+1, product=product_filter, movement_type=movement_type_filter, date_from=date_from, date_to=date_to) }}" 
           class="btn pagination-btn">Siguiente ‚Üí</a>
        <!-- 
        INCREMENTO DE P√ÅGINA:
        page+1 navega a p√°gina siguiente preservando filtros.
        Mismo patr√≥n que p√°gina anterior para consistencia.
        -->
    {% endif %}
</div>
{% endif %}

<!-- RESUMEN DE REGISTROS MOSTRADOS -->
<div class="records-summary">
    <!-- 
    C√ÅLCULO DIN√ÅMICO DE RANGOS CON MATEM√ÅTICAS JINJA2:
    
    F√ìRMULA REGISTRO INICIAL:
    ((page-1) * 50 + 1) if movements else 0
    
    EJEMPLO con page=3:
    (3-1) * 50 + 1 = 101
    
    F√ìRMULA REGISTRO FINAL:
    ((page-1) * 50 + movements|length) if movements else 0
    
    EJEMPLO con page=3, 35 resultados en p√°gina:
    (3-1) * 50 + 35 = 135
    
    PROTECCI√ìN CONTRA P√ÅGINAS VAC√çAS:
    Operador ternario previene mostrar "1-0" cuando no hay datos.
    Sin movements: muestra "0-0 de X registros"
    -->
    Mostrando {{ ((page-1) * 50 + 1) if movements else 0 }} - {{ ((page-1) * 50 + movements|length) if movements else 0 }} de {{ total_records }} registros
    <!-- 
    FILTRO |length:
    Cuenta elementos en la lista 'movements' de la p√°gina actual.
    Esencial para p√°ginas parciales (√∫ltima p√°gina con menos de 50).
    
    RESULTADO EJEMPLO:
    "Mostrando 101-135 de 247 registros"
    -->
</div>
{% endblock %}

<!-- 
=============================================================================
RESUMEN T√âCNICO - INVENTORY_MOVEMENTS.HTML:
=============================================================================

PROP√ìSITO:
Template para mostrar historial completo de movimientos de inventario con 
capacidades avanzadas de filtrado, paginaci√≥n y visualizaci√≥n de datos.

CARACTER√çSTICAS PRINCIPALES:
1. Sistema de filtros m√∫ltiples (producto, tipo, fechas)
2. Paginaci√≥n con elipsis inteligente
3. Preservaci√≥n de estado a trav√©s de URLs
4. Badges visuales para tipos de movimiento
5. C√°lculos matem√°ticos para rangos de registros
6. Auditor√≠a completa con before/after quantities

PATRONES JINJA2 AVANZADOS IMPLEMENTADOS:
- Operadores ternarios para valores condicionales
- Matem√°ticas complejas en templates
- Preservaci√≥n de par√°metros m√∫ltiples en URLs
- For...else loops para estados vac√≠os
- Filtros de formato y conteo (|length)
- Condicionales anidadas para l√≥gica compleja

CASOS DE USO:
- Auditor√≠a de inventario
- Seguimiento de cambios por usuario
- An√°lisis de patrones de movimiento
- Verificaci√≥n de c√°lculos de stock
- Reportes hist√≥ricos filtrados

DEPENDENCIAS T√âCNICAS:
- Flask pagination object
- M√∫ltiples par√°metros de query string
- Sistema de usuarios para accountability
- Base de datos con historial completo
- CSS personalizado para badges y tablas responsive
=============================================================================
-->
