<!-- 
PLANTILLA JINJA2 PARA LISTA PRINCIPAL DE INVENTARIO

Este archivo implementa la p√°gina principal del sistema - la lista de productos.
Es el n√∫cleo del sistema porque proporciona:

1. TABLA COMPLETA DE PRODUCTOS: Vista principal del inventario
2. B√öSQUEDA EN TIEMPO REAL: Filtrado de productos por nombre/SKU/categor√≠a
3. INDICADORES VISUALES: Estados de stock, alertas, c√≥digos de colores
4. ACCIONES R√ÅPIDAS: Editar, ajustar stock desde la tabla
5. RESUMEN ESTAD√çSTICO: Totales y productos con stock bajo
6. CONTROL DE ACCESO: Diferentes vistas seg√∫n rol de usuario

CARACTER√çSTICAS JINJA2 AVANZADAS:
- Formularios de b√∫squeda con preservaci√≥n de estado
- Loops con estados vac√≠os (for...else)
- Condicionales complejas para clases CSS din√°micas
- Filtros de formateo y conteo
- Manejo de roles y permisos
- Colspan din√°mico seg√∫n permisos

FUNCIONALIDADES CLAVE:
- B√∫squeda: GET con par√°metros, filtrado backend
- Estados visuales: CSS classes seg√∫n stock levels
- Responsive: Tabla adaptable a diferentes pantallas
- UX: Feedback inmediato, indicadores claros
- Accesibilidad: C√≥digo sem√°ntico, labels apropiados

TECNOLOG√çAS UTILIZADAS:
- Jinja2: Loops, condicionales, filtros, variables de session
- HTML5: Tabla sem√°ntica, formularios, elementos apropiados
- CSS Grid/Table: Layout responsive y profesional
- JavaScript potencial: B√∫squeda en vivo, ordenamiento
-->

{% extends "layout.html" %}
<!-- 
HERENCIA DE PLANTILLAS:
Utiliza la estructura base compartida con todas las p√°ginas.
Mantiene consistencia en navegaci√≥n, header y footer.
-->

{% block title %}Inventario - Sistema de Inventario{% endblock %}
<!-- T√≠tulo espec√≠fico para la p√°gina principal del inventario -->

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
{% endblock %}
<!-- 
BLOQUE HEAD - CSS ESPEC√çFICO:
Los estilos de index.css incluyen:
- Tabla responsive con scroll horizontal
- Estados visuales: .low-stock, .status-ok, .status-low-stock
- Formulario de b√∫squeda inline
- Botones de acci√≥n compactos
- Indicadores de SKU y c√≥digos
- Layout grid para header con acciones
- Estados hover para filas de tabla
- Badges y elementos de estado
-->

{% block content %}
<!-- INICIO DEL CONTENIDO PRINCIPAL -->
<div class="inventory-header">
    <!-- 
    HEADER DE LA P√ÅGINA DE INVENTARIO:
    Combina t√≠tulo principal con acciones y b√∫squeda.
    Layout flexible que se adapta a diferentes pantallas.
    -->
    <h2>Inventario de Productos</h2>
    <div class="inventory-actions">
        <!-- 
        CONTENEDOR DE ACCIONES:
        Agrupa formulario de b√∫squeda y botones de acci√≥n.
        CSS Flexbox permite alineaci√≥n responsive.
        -->
        
        <form method="GET" class="search-form">
        <!-- 
        FORMULARIO DE B√öSQUEDA:
        - method="GET": Los par√°metros aparecen en URL (?search=t√©rmino)
        - Permite compartir enlaces con b√∫squedas espec√≠ficas
        - Navegaci√≥n del navegador funciona (back/forward)
        - SEO friendly para b√∫squedas p√∫blicas
        -->
            <input type="text" name="search" placeholder="Buscar productos..." 
                   value="{{ search_query or '' }}" 
                   class="search-input">
            <!-- 
            INPUT DE B√öSQUEDA CON PRESERVACI√ìN DE ESTADO:
            value="{{ search_query or '' }}"
            
            C√ìMO FUNCIONA:
            1. Usuario escribe "laptop" y busca
            2. URL cambia a: /?search=laptop
            3. Flask procesa: search_query = request.args.get('search')
            4. Template renderiza: value="laptop"
            5. Campo mantiene el t√©rmino despu√©s de la b√∫squeda
            
            OPERADOR OR:
            - Si search_query existe: usa su valor
            - Si search_query es None/vac√≠o: usa string vac√≠o ''
            - Evita errores cuando no hay b√∫squeda activa
            -->
            
            <button type="submit" class="btn search-btn">üîç</button>
            <!-- 
            BOT√ìN DE B√öSQUEDA:
            - type="submit": Env√≠a el formulario al hacer clic
            - Emoji üîç como icono visual universal
            - class="search-btn": Estilos espec√≠ficos para bot√≥n de b√∫squeda
            -->
            
            {% if search_query %}
            <!-- 
            BOT√ìN CONDICIONAL - LIMPIAR B√öSQUEDA:
            Solo aparece cuando hay una b√∫squeda activa.
            Mejora UX permitiendo volver al estado original f√°cilmente.
            -->
            <a href="{{ url_for('home') }}" class="btn clear-btn">Limpiar</a>
            <!-- 
            ENLACE DE LIMPIEZA:
            - url_for('home'): Navega a la misma p√°gina sin par√°metros
            - Efectivamente remueve ?search=t√©rmino de la URL
            - Resultado: vuelve a mostrar todos los productos
            -->
            {% endif %}
        </form>
        
        {% if session.role in ['admin', 'editor'] %}
        <!-- 
        CONTROL DE ACCESO BASADO EN ROLES:
        Solo usuarios con permisos de escritura ven el bot√≥n de agregar.
        
        ROLES DEL SISTEMA:
        - 'admin': Acceso completo
        - 'editor': Puede crear/editar productos
        - 'viewer': Solo lectura (no ve este bot√≥n)
        -->
        <a href="{{ url_for('add_product') }}" class="btn btn-success">Agregar Producto</a>
        <!-- 
        BOT√ìN DE ACCI√ìN PRINCIPAL:
        - url_for('add_product'): Navega al formulario de creaci√≥n
        - class="btn btn-success": Estilo de bot√≥n exitoso (verde)
        - Ubicaci√≥n prominente para acci√≥n frecuente
        -->
        {% endif %}
    </div>
</div>

{% if search_query %}
<!-- 
SECCI√ìN DE RESULTADOS DE B√öSQUEDA:
Aparece solo cuando hay una b√∫squeda activa.
Proporciona feedback inmediato sobre qu√© se busc√≥ y cu√°ntos resultados hay.
-->
<div class="search-results">
    <strong>Resultados de b√∫squeda para:</strong> "{{ search_query }}"
    <span class="search-results-count">({{ productos|length }} resultado{{ 's' if productos|length != 1 else '' }})</span>
    <!-- 
    PLURALIZACI√ìN INTELIGENTE EN JINJA2:
    {{ 's' if productos|length != 1 else '' }}
    
    C√ìMO FUNCIONA:
    1. productos|length: Cuenta elementos en la lista
    2. != 1: Compara si NO es exactamente 1
    3. if/else ternario: Si no es 1 ‚Üí 's', si es 1 ‚Üí ''
    
    EJEMPLOS:
    - 0 productos ‚Üí "0 resultados"
    - 1 producto ‚Üí "1 resultado" 
    - 5 productos ‚Üí "5 resultados"
    
    MEJORA DE UX:
    Texto gramaticalmente correcto mejora profesionalismo.
    -->
</div>
{% endif %}

<div class="inventory-table-container">
    <!-- 
    CONTENEDOR DE TABLA CON SCROLL:
    Permite scroll horizontal en pantallas peque√±as.
    Mantiene headers visibles durante scroll vertical.
    -->
    <table>
        <thead>
            <tr>
                <!-- 
                HEADERS DE TABLA:
                Definen las columnas del inventario.
                Orden optimizado para flujo de lectura: nombre ‚Üí identificaci√≥n ‚Üí categor√≠a ‚Üí datos num√©ricos
                -->
                <th>Nombre</th>
                <th>SKU</th>
                <th>Categor√≠a</th>
                <th>Cantidad</th>
                <th>Precio</th>
                <th>Proveedor</th>
                <th>Stock M√≠nimo</th>
                <th>Fecha de Creaci√≥n</th>
                <th>Estado</th>
                {% if session.role in ['admin', 'editor'] %}
                <!-- 
                COLUMNA CONDICIONAL - ACCIONES:
                Solo aparece para usuarios con permisos de edici√≥n.
                Reduces visual clutter para usuarios de solo lectura.
                -->
                <th>Acciones</th>
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for producto in productos %}
            <!-- 
            LOOP PRINCIPAL DE PRODUCTOS:
            Itera sobre la lista de productos obtenida desde Flask.
            Cada 'producto' es un diccionario con datos de una fila de BD.
            -->
            <tr {% if producto['quantity'] < producto['stock_min'] %}class="low-stock"{% endif %}>
            <!-- 
            CLASE CSS CONDICIONAL EN FILA:
            {% if producto['quantity'] < producto['stock_min'] %}class="low-stock"{% endif %}
            
            L√ìGICA:
            - Si stock actual < stock m√≠nimo ‚Üí aplica class="low-stock"
            - Si stock es adecuado ‚Üí no aplica clase (fila normal)
            
            RESULTADO EN HTML:
            - Stock bajo: <tr class="low-stock">
            - Stock OK: <tr>
            
            CSS STYLING:
            .low-stock puede tener:
            - background-color: #ffebee; (fondo rojo claro)
            - border-left: 4px solid red; (borde izquierdo rojo)
            - Efecto visual inmediato para productos que necesitan atenci√≥n
            -->
                <td>{{ producto['name'] }}</td>
                <!-- Nombre del producto - dato principal -->
                
                <td>
                    {% if producto['sku'] %}
                    <!-- 
                    CONDICIONAL PARA SKU:
                    Algunos productos pueden no tener SKU asignado.
                    Maneja elegantemente la ausencia de datos.
                    -->
                        <code class="sku-code">{{ producto['sku'] }}</code>
                        <!-- 
                        ELEMENTO CODE PARA SKU:
                        <code> es sem√°nticamente correcto para c√≥digos.
                        class="sku-code" permite estilos espec√≠ficos:
                        - font-family: monospace;
                        - background: gray;
                        - padding: 2px 4px;
                        - border-radius: 3px;
                        -->
                    {% else %}
                        <span class="no-sku">Sin SKU</span>
                        <!-- 
                        ESTADO VAC√çO PARA SKU:
                        Texto expl√≠cito mejor que celda vac√≠a.
                        class="no-sku" puede usar estilos tenues:
                        - color: #999;
                        - font-style: italic;
                        -->
                    {% endif %}
                </td>
                <td>{{ producto['category'] }}</td>
                <!-- Categor√≠a del producto -->
                
                <td>{{ producto['quantity'] }}</td>
                <!-- Cantidad actual en stock -->
                
                <td>${{ "%.2f"|format(producto['price']) }}</td>
                <!-- 
                PRECIO CON FORMATEO:
                "%.2f"|format(producto['price'])
                
                FILTRO DE FORMATO NUM√âRICO:
                - %.2f: Formato con exactamente 2 decimales
                - Convierte 123.5 ‚Üí "123.50"
                - Convierte 45 ‚Üí "45.00"
                - Prefijo $: S√≠mbolo de moneda
                
                RESULTADO: "$123.50", "$45.00", "$0.99"
                Consistencia visual en columna de precios.
                -->
                
                <td>{{ producto['provider'] }}</td>
                <!-- Proveedor del producto -->
                
                <td>{{ producto['stock_min'] }}</td>
                <!-- Stock m√≠nimo configurado para alertas -->
                
                <td>{{ producto['created_at'] }}</td>
                <!-- Fecha de creaci√≥n del producto -->
                
                <td>
                    {% if producto['quantity'] < producto['stock_min'] %}
                    <!-- 
                    INDICADOR DE ESTADO VISUAL:
                    L√≥gica duplicada de la clase de fila, pero para contenido.
                    Proporciona informaci√≥n expl√≠cita en texto.
                    -->
                        <span class="status-low-stock">Stock Bajo</span>
                        <!-- 
                        BADGE DE ESTADO CR√çTICO:
                        class="status-low-stock" puede incluir:
                        - background: red/orange;
                        - color: white;
                        - padding: 4px 8px;
                        - border-radius: 12px;
                        - font-weight: bold;
                        -->
                    {% else %}
                        <span class="status-ok">OK</span>
                        <!-- 
                        BADGE DE ESTADO NORMAL:
                        class="status-ok" con estilos positivos:
                        - background: green;
                        - color: white;
                        - Mismos estilos de badge pero color diferente
                        -->
                    {% endif %}
                </td>
                {% if session.role in ['admin', 'editor'] %}
                <!-- 
                COLUMNA DE ACCIONES CONDICIONAL:
                Solo se renderiza para usuarios con permisos de edici√≥n.
                Mantiene la tabla limpia para usuarios de solo lectura.
                -->
                <td>
                    <div class="actions-container">
                        <!-- 
                        CONTENEDOR DE ACCIONES:
                        Agrupa botones relacionados para mejor layout.
                        CSS Flexbox permite alineaci√≥n horizontal compacta.
                        -->
                        
                        <a href="{{ url_for('edit_product', product_id=producto['id']) }}" 
                           class="btn action-btn">
                            ‚úèÔ∏è Editar
                        </a>
                        <!-- 
                        ENLACE DE EDICI√ìN:
                        url_for('edit_product', product_id=producto['id'])
                        
                        GENERACI√ìN DE URL:
                        - Funci√≥n: edit_product(product_id)
                        - Par√°metro: product_id=producto['id']
                        - Resultado: /edit/123 (donde 123 es el ID)
                        
                        FLUJO:
                        1. Usuario hace clic ‚Üí Navega a /edit/123
                        2. Flask ejecuta edit_product(123)
                        3. Carga datos del producto ID 123
                        4. Renderiza edit_product.html con datos pre-poblados
                        -->
                        
                        <a href="{{ url_for('quick_stock_adjustment', product_id=producto['id']) }}" 
                           class="btn adjust-btn">
                            üîß Ajustar
                        </a>
                        <!-- 
                        ENLACE DE AJUSTE R√ÅPIDO:
                        Acci√≥n espec√≠fica para modificar solo el stock.
                        M√°s r√°pido que edici√≥n completa para ajustes de inventario.
                        
                        CASOS DE USO:
                        - Inventario f√≠sico
                        - Correcci√≥n de errores de stock
                        - Ajustes por merma/da√±o
                        - Reconciliaci√≥n de diferencias
                        -->
                    </div>
                </td>
                {% endif %}
            </tr>
            {% else %}
            <!-- 
            ELSE DE LOOP FOR - ESTADO VAC√çO:
            Esta es una caracter√≠stica especial de Jinja2.
            
            C√ìMO FUNCIONA FOR...ELSE:
            - Si productos tiene elementos: ejecuta el loop normal
            - Si productos est√° vac√≠o: ejecuta solo la parte else del for
            - No se ejecuta si el loop se ejecut√≥ al menos una vez
            
            CASOS DONDE SE EJECUTA ELSE:
            1. No hay productos en la BD
            2. B√∫squeda no encontr√≥ resultados
            3. Filtros eliminaron todos los productos
            4. Error en consulta (productos = [])
            -->
            <tr>
                <td colspan="{% if session.role in ['admin', 'editor'] %}10{% else %}9{% endif %}" class="no-products">
                    No hay productos en el inventario.
                </td>
                <!-- 
                COLSPAN DIN√ÅMICO:
                {% if session.role in ['admin', 'editor'] %}10{% else %}9{% endif %}
                
                L√ìGICA:
                - Admin/Editor: 10 columnas (incluye columna "Acciones")
                - Viewer: 9 columnas (sin columna "Acciones")
                
                PROP√ìSITO:
                Hace que la celda "No hay productos" ocupe toda la fila.
                Sin colspan correcto, el mensaje aparecer√≠a solo en primera columna.
                
                RESULTADO HTML:
                - Admin: <td colspan="10" class="no-products">
                - Viewer: <td colspan="9" class="no-products">
                -->
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if productos %}
<!-- 
SECCI√ìN DE RESUMEN ESTAD√çSTICO:
Solo aparece cuando hay productos para mostrar.
Proporciona m√©tricas √∫tiles al final de la tabla.
-->
<div class="inventory-summary">
    <strong>Total de productos:</strong> {{ productos|length }}
    <!-- 
    CONTEO CON FILTRO LENGTH:
    productos|length cuenta elementos en la lista.
    
    IMPORTANTE:
    Este conteo refleja los productos MOSTRADOS, no todos los de la BD.
    - Sin b√∫squeda: cuenta todos los productos
    - Con b√∫squeda: cuenta solo los resultados filtrados
    - Proporciona contexto inmediato sobre lo que ve el usuario
    -->
    <br>
    <strong>Productos con stock bajo:</strong> {{ low_stock_count }}
    <!-- 
    CONTADOR DE STOCK BAJO:
    low_stock_count viene calculado desde Flask.
    
    C√ÅLCULO EN BACKEND:
    SELECT COUNT(*) FROM products WHERE quantity < stock_min
    
    VENTAJAS DE C√ÅLCULO EN BACKEND:
    - M√°s eficiente que calcular en template
    - Consistente con datos de BD
    - Puede incluir l√≥gica compleja (productos activos, etc.)
    - No afectado por paginaci√≥n o filtros de frontend
    -->
</div>
{% endif %}
{% endblock %}
<!-- 
ENDBLOCK:
Cierra el bloque 'content' definido al inicio.

RESUMEN DE CARACTER√çSTICAS JINJA2 EN ESTE TEMPLATE:

1. HERENCIA: extends de layout.html
2. BLOQUES: block title, block head, block content 
3. VARIABLES: search_query, producto name y otros campos
4. FILTROS: productos length, format de precios
5. CONDICIONALES: if search_query, if session role
6. LOOPS: for producto in productos con jinja2
7. ELSE DE LOOP: else de for (cuando no hay productos)
8. OPERADOR OR: search_query or con valores por defecto
9. EXPRESIONES TERNARIAS: condicionales inline con if/else
10. CLASES CSS DIN√ÅMICAS: class="low-stock" condicional
11. URLS DIN√ÅMICAS: url_for con par√°metros din√°micos
12. ACCESO A SESSION: session.role para control de permisos
13. COLSPAN DIN√ÅMICO: colspan con condicional
14. ELEMENTOS SEM√ÅNTICOS: code, strong, span apropiados

FLUJO COMPLETO DE LA P√ÅGINA:
1. Usuario accede a / (home)
2. Flask ejecuta home() en app.py
3. Consulta productos de BD
4. Renderiza index.html con productos=lista_de_productos
5. Jinja2 procesa loops, condicionales y filtros
6. Genera HTML final con datos din√°micos
7. Navegador muestra tabla interactiva
8. Usuario puede buscar, editar, ajustar desde la misma p√°gina

EXTENSIBILIDAD:
- Ordenamiento de columnas (JavaScript + backend)
- Paginaci√≥n para inventarios grandes
- Filtros avanzados (categor√≠a, proveedor, stock)
- Exportaci√≥n a CSV/Excel
- Selecci√≥n m√∫ltiple para acciones en lote
- Gr√°ficos de distribuci√≥n de stock
-->