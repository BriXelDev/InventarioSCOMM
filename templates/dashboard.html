<!-- 
PLANTILLA JINJA2 PARA DASHBOARD PRINCIPAL

Este archivo implementa el panel de control principal del sistema de inventario.
Es la pantalla m√°s importante porque proporciona:

1. ESTAD√çSTICAS EN TIEMPO REAL: Total productos, valor, alertas
2. PRODUCTOS CON ALERTAS: Stock bajo y sin stock  
3. ACTIVIDAD DE USUARIOS: Movimientos recientes por usuario
4. MOVIMIENTOS RECIENTES: Historial de cambios en inventario
5. ACCIONES R√ÅPIDAS: Enlaces directos a funciones importantes

CARACTER√çSTICAS T√âCNICAS:
- Jinja2: Condicionales complejas, loops, filtros de formato
- JavaScript: dashboard.js para funcionalidad din√°mica
- CSS Grid: Layout responsive para cards de estad√≠sticas  
- Tablas din√°micas: Generadas seg√∫n datos disponibles
- Sistema de roles: Diferentes vistas seg√∫n permisos

TECNOLOG√çAS UTILIZADAS:
- Flask: Datos din√°micos desde el backend
- Jinja2: Renderizado condicional y loops
- HTML5: Elementos sem√°nticos y estructura
- CSS Grid/Flexbox: Layout moderno y responsive
- JavaScript: Interactividad y actualizaciones en tiempo real
-->

{% extends "layout.html" %}
<!-- 
HERENCIA DE PLANTILLAS:
Hereda la estructura base de layout.html (header, navegaci√≥n, footer)
Este template define solo el contenido espec√≠fico del dashboard
-->

{% block title %}Dashboard - Sistema de Inventario{% endblock %}
<!-- T√≠tulo que aparecer√° en la pesta√±a del navegador -->

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}
<!-- 
BLOQUE HEAD - CSS ESPEC√çFICO:
Incluye estilos espec√≠ficos para el dashboard. url_for() genera la ruta segura.
Los estilos incluyen:
- Grid layout para cards de estad√≠sticas
- Estilos para tablas de alertas y movimientos
- Badges y estados visuales (cr√≠tico, warning, etc.)
- Responsive design para diferentes pantallas
- Animaciones para cards y elementos interactivos
-->

{% block content %}
<!-- INICIO DEL CONTENIDO PRINCIPAL DEL DASHBOARD -->
<div class="dashboard-header">
    <!-- 
    HEADER DEL DASHBOARD:
    Secci√≥n superior con t√≠tulo y informaci√≥n de actualizaci√≥n.
    Proporciona contexto temporal sobre la frescura de los datos.
    -->
    <h2>üìä Dashboard</h2>
    <div class="last-update">
        √öltima actualizaci√≥n: <span id="lastUpdate"></span>
        <!-- 
        ELEMENTO DIN√ÅMICO:
        El span con id="lastUpdate" ser√° poblado por JavaScript
        en dashboard.js para mostrar cu√°ndo se actualizaron los datos.
        -->
    </div>
</div>

<!-- GRID DE ESTAD√çSTICAS PRINCIPALES -->
<div class="stats-grid">
    <!-- 
    CONTENEDOR GRID PARA CARDS:
    CSS Grid layout que organiza las estad√≠sticas en cards.
    Se adapta autom√°ticamente a diferentes tama√±os de pantalla:
    - Desktop: 4 columnas
    - Tablet: 2 columnas  
    - Mobile: 1 columna
    -->
    
    <div class="stat-card stat-card-products">
        <!-- 
        CARD DE TOTAL PRODUCTOS:
        Primera estad√≠stica principal. Muestra el n√∫mero total de productos √∫nicos.
        La clase stat-card-products permite estilos espec√≠ficos (color, icono).
        -->
        <div class="stat-card-content">
            <div>
                <h3>{{ dashboard_stats['total_products'] or 0 }}</h3>
                <!-- 
                JINJA2 VALOR CON FALLBACK:
                dashboard_stats es un diccionario enviado desde Flask.
                El operador 'or 0' proporciona un valor por defecto si:
                - dashboard_stats es None
                - dashboard_stats['total_products'] no existe
                - El valor es falsy (None, 0, '', etc.)
                -->
                <p>Total Productos</p>
            </div>
            <div class="stat-icon">üì¶</div>
            <!-- Emoji como icono visual para identificar r√°pidamente la m√©trica -->
        </div>
    </div>
    
    <div class="stat-card stat-card-items">
        <!-- CARD DE TOTAL ART√çCULOS (suma de cantidades) -->
        <div class="stat-card-content">
            <div>
                <h3>{{ dashboard_stats['total_items'] or 0 }}</h3>
                <p>Total Art√≠culos</p>
                <!-- 
                DIFERENCIA CONCEPTUAL:
                - total_products: N√∫mero de productos √∫nicos (filas en BD)
                - total_items: Suma de todas las cantidades (inventario f√≠sico)
                -->
            </div>
            <div class="stat-icon">üìà</div>
        </div>
    </div>
    
    <div class="stat-card stat-card-value">
        <!-- CARD DE VALOR TOTAL DEL INVENTARIO -->
        <div class="stat-card-content">
            <div>
                <h3>${{ "%.0f"|format(dashboard_stats['total_value'] or 0) }}</h3>
                <!-- 
                JINJA2 FILTRO DE FORMATO NUM√âRICO:
                "%.0f"|format() es un filtro que:
                1. Formatea n√∫meros con 0 decimales (%.0f)
                2. Similar a printf en C o format() en Python
                3. Convierte 1234.56 en "1235" (redondeado)
                4. Maneja None/valores vac√≠os con 'or 0'
                -->
                <p>Valor Total</p>
            </div>
            <div class="stat-icon">üí∞</div>
        </div>
    </div>
    
    <div class="stat-card stat-card-low-stock">
        <!-- CARD DE ALERTA - PRODUCTOS CON STOCK BAJO -->
        <div class="stat-card-content">
            <div>
                <h3>{{ dashboard_stats['low_stock_count'] or 0 }}</h3>
                <p>Stock Bajo</p>
                <!-- 
                M√âTRICA DE ALERTA:
                Cuenta productos donde quantity < min_stock.
                Cr√≠tico para gesti√≥n proactiva del inventario.
                -->
            </div>
            <div class="stat-icon">‚ö†Ô∏è</div>
            <!-- Emoji de warning para indicar que requiere atenci√≥n -->
        </div>
    </div>
</div>

<!-- CONTENIDO PRINCIPAL DEL DASHBOARD -->
<div class="main-content">
    <!-- 
    CONTENEDOR PRINCIPAL:
    Organiza las secciones principales del dashboard:
    - Productos que necesitan atenci√≥n (alertas)
    - Actividad reciente de usuarios
    Cada secci√≥n es independiente y se puede mostrar/ocultar seg√∫n datos
    -->
    
    <!-- SECCI√ìN DE PRODUCTOS CON ALERTA -->
    <div>
        <h3>üö® Productos que Necesitan Atenci√≥n</h3>
        <div class="alert-section">
            {% if alert_products %}
            <!-- 
            CONDICIONAL JINJA2 - PRODUCTOS CON ALERTAS:
            Esta condici√≥n verifica si existe la lista alert_products y no est√° vac√≠a.
            alert_products viene desde Flask con productos donde quantity <= min_stock
            -->
            <table>
                <thead>
                    <tr>
                        <th>Estado</th>
                        <th>Producto</th>
                        <th>Stock Actual</th>
                        <th>Stock M√≠nimo</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in alert_products %}
                    <!-- 
                    LOOP JINJA2 PARA PRODUCTOS CR√çTICOS:
                    Itera sobre cada producto que necesita atenci√≥n.
                    Cada 'product' es un diccionario con datos del producto.
                    -->
                    <tr>
                        <td>
                            {% if product['alert_level'] == 'critical' %}
                            <!-- 
                            CONDICIONAL ANIDADO - NIVEL CR√çTICO:
                            alert_level es calculado en el backend:
                            - 'critical': quantity = 0 (sin stock)
                            - 'warning': 0 < quantity < min_stock (stock bajo)
                            -->
                                <span class="alert-badge alert-critical">
                                    üî¥ Sin Stock
                                </span>
                            {% elif product['alert_level'] == 'warning' %}
                                <span class="alert-badge alert-warning">
                                    üü° Stock Bajo
                                </span>
                            {% endif %}
                            <!-- 
                            BADGES VISUALES:
                            Elementos <span> con clases CSS que proporcionan:
                            - Colores distintivos (rojo para cr√≠tico, amarillo para warning)
                            - Emojis para reconocimiento visual r√°pido
                            - Estilos consistentes en toda la aplicaci√≥n
                            -->
                        </td>
                        <td>{{ product['name'] }}</td>
                        <td class="{{ 'stock-critical' if product['alert_level'] == 'critical' else 'stock-warning' }}">
                            {{ product['quantity'] }}
                            <!-- 
                            JINJA2 EXPRESI√ìN CONDICIONAL INLINE:
                            La clase CSS se determina din√°micamente:
                            - Si alert_level == 'critical' ‚Üí class="stock-critical"
                            - Si no ‚Üí class="stock-warning"
                            
                            Esto permite estilos diferentes seg√∫n la severidad:
                            - stock-critical: texto rojo, fondo rojo claro
                            - stock-warning: texto naranja, fondo amarillo claro
                            -->
                        </td>
                        <td>{{ product['stock_min'] }}</td>
                        <td>
                            {% if session.role in ['admin', 'editor'] %}
                            <!-- 
                            CONTROL DE ACCESO BASADO EN ROLES:
                            session.role viene de Flask session (login).
                            Solo usuarios con rol 'admin' o 'editor' pueden ajustar stock.
                            
                            OPERADOR 'IN' DE JINJA2:
                            Similar a Python: verifica si el valor est√° en la lista.
                            session.role in ['admin', 'editor'] es True si el usuario
                            tiene permisos para modificar inventario.
                            -->
                            <a href="{{ url_for('quick_stock_adjustment', product_id=product['id']) }}" 
                               class="btn adjust-btn">
                                üîß Ajustar
                            </a>
                            <!-- 
                            URL_FOR CON PAR√ÅMETROS:
                            url_for('quick_stock_adjustment', product_id=product['id'])
                            
                            Genera URL como: /quick-stock-adjustment/123
                            donde 123 es el ID del producto espec√≠fico.
                            Flask usar√° este ID para cargar el producto correcto.
                            -->
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <!-- 
            ESTADO VAC√çO - NO HAY ALERTAS:
            Esta rama se ejecuta cuando alert_products est√° vac√≠o o es None.
            Proporciona feedback positivo al usuario.
            -->
            <div class="no-alerts">
                <div class="no-alerts-icon">‚úÖ</div>
                <p>¬°Excelente! Todos los productos tienen stock adecuado.</p>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- SECCI√ìN DE ACTIVIDAD DE USUARIOS -->
    <div>
        <h3>üë• Actividad de Usuarios (7 d√≠as)</h3>
        <div class="activity-section">
            {% if user_activity %}
            <!-- 
            CONDICIONAL PARA ACTIVIDAD DE USUARIOS:
            user_activity contiene estad√≠sticas de los √∫ltimos 7 d√≠as:
            - N√∫mero de movimientos por usuario
            - Total de unidades movidas por usuario
            - Se genera en Flask con consultas agregadas (GROUP BY)
            -->
            {% for user in user_activity %}
            <!-- 
            LOOP PARA CADA USUARIO ACTIVO:
            Cada 'user' es un diccionario con:
            - username: nombre del usuario
            - movement_count: n√∫mero de movimientos realizados
            - total_quantity_moved: suma de cantidades movidas
            -->
            <div class="user-activity-item">
                <div>
                    <div class="user-activity-name">{{ user['username'] }}</div>
                    <div class="user-activity-movements">{{ user['movement_count'] }} movimientos</div>
                    <!-- 
                    PLURALIZACI√ìN AUTOM√ÅTICA:
                    El texto dice "movimientos" (plural) incluso si es 1.
                    Una mejora ser√≠a: 
                    {{ user['movement_count'] }} movimiento{{ 's' if user['movement_count'] != 1 else '' }}
                    -->
                </div>
                <div class="user-activity-stats">
                    <div class="user-activity-quantity">{{ user['total_quantity_moved'] }}</div>
                    <div class="user-activity-units">unidades</div>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <!-- ESTADO VAC√çO - SIN ACTIVIDAD -->
            <div class="no-activity">
                <div class="no-activity-icon">üìã</div>
                <p>No hay actividad reciente</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- SECCI√ìN DE MOVIMIENTOS RECIENTES -->
<div>
    <h3>üìã Movimientos Recientes</h3>
    <div class="movements-section">
        {% if recent_movements %}
        <!-- 
        CONDICIONAL PARA MOVIMIENTOS RECIENTES:
        recent_movements es una lista de los √∫ltimos movimientos de inventario.
        Incluye entradas, salidas, creaciones y eliminaciones de productos.
        Se ordena por fecha descendente (m√°s recientes primero).
        -->
        <table>
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Producto</th>
                    <th>Tipo</th>
                    <th>Cambio</th>
                    <th>Usuario</th>
                </tr>
            </thead>
            <tbody>
                {% for movement in recent_movements %}
                <!-- 
                LOOP PARA CADA MOVIMIENTO:
                Cada 'movement' contiene:
                - created_at: timestamp del movimiento
                - product_name: nombre del producto afectado
                - movement_type: tipo de operaci√≥n (entrada/salida/etc.)
                - quantity_change: cambio en la cantidad (+/-)
                - username: quien realiz√≥ el movimiento
                -->
                <tr>
                    <td>{{ movement['created_at'] }}</td>
                    <td>{{ movement['product_name'] }}</td>
                    <td>
                        {% if movement['movement_type'] == 'entrada' %}
                        <!-- 
                        CONDICIONALES PARA TIPO DE MOVIMIENTO:
                        Cada tipo tiene su propio badge visual con:
                        - Color espec√≠fico (definido en CSS)
                        - Emoji para reconocimiento visual
                        - Texto descriptivo
                        -->
                            <span class="movement-badge movement-entrada">
                                ‚¨ÜÔ∏è Entrada
                            </span>
                        {% elif movement['movement_type'] == 'salida' %}
                            <span class="movement-badge movement-salida">
                                ‚¨áÔ∏è Salida
                            </span>
                        {% elif movement['movement_type'] == 'creacion' %}
                            <span class="movement-badge movement-creacion">
                                ‚ú® Creaci√≥n
                            </span>
                        {% elif movement['movement_type'] == 'eliminacion' %}
                            <span class="movement-badge movement-eliminacion">
                                üóëÔ∏è Eliminaci√≥n
                            </span>
                        {% endif %}
                        <!-- 
                        BADGES CON CLASES DIN√ÅMICAS:
                        movement-badge: clase base para todos los badges
                        movement-[tipo]: clase espec√≠fica para colores
                        
                        CSS puede usar estas clases como:
                        .movement-entrada { background: green; }
                        .movement-salida { background: red; }
                        .movement-creacion { background: blue; }
                        .movement-eliminacion { background: gray; }
                        -->
                    </td>
                    <td>
                        {% if movement['quantity_change'] > 0 %}
                        <!-- 
                        L√ìGICA CONDICIONAL PARA CAMBIOS DE CANTIDAD:
                        El quantity_change puede ser:
                        - Positivo: aument√≥ el stock (entrada, ajuste positivo)
                        - Negativo: disminuy√≥ el stock (salida, ajuste negativo)  
                        - Cero: movimiento sin cambio de cantidad (edici√≥n de datos)
                        -->
                            <span class="quantity-positive">+{{ movement['quantity_change'] }}</span>
                            <!-- 
                            FORMATO POSITIVO:
                            Muestra + expl√≠cito para cambios positivos.
                            CSS puede colorear en verde para indicar crecimiento.
                            -->
                        {% elif movement['quantity_change'] < 0 %}
                            <span class="quantity-negative">{{ movement['quantity_change'] }}</span>
                            <!-- 
                            FORMATO NEGATIVO:
                            El signo negativo ya est√° incluido en el n√∫mero.
                            CSS puede colorear en rojo para indicar reducci√≥n.
                            -->
                        {% else %}
                            <span class="quantity-neutral">0</span>
                            <!-- 
                            CAMBIO NEUTRO:
                            Para movimientos que no afectan cantidad
                            (como editar nombre del producto).
                            -->
                        {% endif %}
                    </td>
                    <td>{{ movement['username'] }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <!-- ESTADO VAC√çO - SIN MOVIMIENTOS -->
        <div class="no-movements">
            <div class="no-movements-icon">üìã</div>
            <p>No hay movimientos recientes</p>
            <!-- 
            FEEDBACK PARA ESTADO VAC√çO:
            Se muestra cuando:
            - Es un sistema nuevo sin actividad
            - Se filtraron todos los movimientos
            - Hay un error en la consulta de datos
            -->
        </div>
        {% endif %}
    </div>
</div>

<!-- BOT√ìN FLOTANTE DE ACCIONES R√ÅPIDAS -->
<div class="floating-actions">
    <!-- 
    BOTONES FLOTANTES (FAB - Floating Action Button):
    Elementos que permanecen visibles mientras el usuario navega por el dashboard.
    Proporcionan acceso r√°pido a las acciones m√°s importantes.
    
    POSICIONAMIENTO:
    - position: fixed en CSS
    - Esquina inferior derecha t√≠picamente
    - z-index alto para estar sobre otros elementos
    -->
    {% if session.role in ['admin', 'editor'] %}
    <!-- 
    CONTROL DE ACCESO:
    Solo usuarios con permisos de edici√≥n pueden ver las acciones r√°pidas.
    Esto evita confusi√≥n a usuarios que solo tienen permisos de lectura.
    -->
    <a href="{{ url_for('add_product') }}" class="floating-btn">
        ‚ûï Agregar Producto
    </a>
    <!-- 
    ENLACE COMO BOT√ìN FLOTANTE:
    - url_for('add_product'): Navega a la p√°gina de agregar producto
    - class="floating-btn": Estilos CSS para bot√≥n flotante
    - Emoji ‚ûï: Icono universal para "agregar"
    
    EXTENSIBILIDAD:
    Se pueden agregar m√°s botones flotantes:
    - Ajuste r√°pido de stock
    - Generar reporte
    - Configuraci√≥n
    -->
    {% endif %}
</div>

<!-- CARGA DE JAVASCRIPT ESPEC√çFICO -->
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<!-- 
JAVASCRIPT DEL DASHBOARD
-->
{% endblock %}
<!-- 
ENDBLOCK:
Cierra el bloque 'content' que se defini√≥ al inicio.
Este contenido se insertar√° en layout.html en el √°rea principal.
-->
