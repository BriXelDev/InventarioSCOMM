<!-- 
PLANTILLA JINJA2 PARA REPORTES PERSONALIZADOS

Este archivo implementa una interfaz compleja para generar reportes din√°micos
con m√∫ltiples tipos de an√°lisis y filtros. Es uno de los templates m√°s avanzados
del sistema porque:

1. FORMULARIOS DIN√ÅMICOS: Campos que aparecen/desaparecen seg√∫n selecci√≥n
2. RENDERIZADO CONDICIONAL: Diferentes tablas seg√∫n tipo de reporte  
3. MANEJO DE ESTADOS VAC√çOS: UX mejorada cuando no hay resultados
4. EXPORTACI√ìN: Generaci√≥n de CSV con mismos filtros
5. FILTROS COMPLEJOS: Fechas, categor√≠as, proveedores, niveles de stock

TECNOLOG√çAS UTILIZADAS:
- Jinja2: Herencia, bloques, condicionales, loops
- JavaScript: Formularios din√°micos y interactividad
- CSS Grid: Layout responsive para formularios y resultados
- HTML5: Elementos sem√°nticos y validaci√≥n
-->

{% extends "layout.html" %}
<!-- 
HERENCIA DE PLANTILLAS:
Hereda de layout.html que contiene la estructura base (header, nav, footer)
Este template solo define el contenido espec√≠fico de reportes personalizados
-->

{% block title %}Reportes Personalizados - Sistema de Inventario{% endblock %}
<!-- T√≠tulo que aparecer√° en la pesta√±a del navegador -->

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/custom_reports.css') }}">
{% endblock %}
<!-- 
BLOQUE HEAD - CSS ESPEC√çFICO:
Incluye estilos espec√≠ficos para esta p√°gina. url_for() genera la ruta segura.
Los estilos incluyen:
- Grid layouts para formularios complejos
- Estilos para tablas de resultados din√°micas
- Estados de filtros y mensajes de no-resultados
- Responsive design para diferentes tipos de reportes
-->

{% block content %}
<!-- INICIO DEL CONTENIDO PRINCIPAL -->

<div class="page-header">
    <!-- 
    ENCABEZADO DE P√ÅGINA:
    Header visual con t√≠tulo e introducci√≥n. Los emojis mejoran la UX
    y hacen la interfaz m√°s amigable visualmente.
    -->
    <h1>üìà Reportes Personalizados</h1>
    <p>Genera reportes espec√≠ficos seg√∫n tus necesidades</p>
</div>

<div class="report-container">
    <!-- CONTENEDOR PRINCIPAL que organiza formulario y resultados -->
    
    <div class="report-form-section">
        <!-- SECCI√ìN DEL FORMULARIO DE CONFIGURACI√ìN -->
        <h2>Generar Reporte</h2>
        
        <form method="POST" action="{{ url_for('generate_custom_report') }}" class="report-form">
        <!-- 
        FORMULARIO PRINCIPAL:
        - method="POST": Env√≠o seguro de datos
        - action="{{ url_for('generate_custom_report') }}": URL din√°mica a la funci√≥n Flask
        - Los datos se procesar√°n en generate_custom_report() de app.py
        -->
        
            <div class="form-grid">
            <!-- Grid CSS para organizar campos de forma responsive -->
            
                <div class="form-group">
                    <label for="report_type">Tipo de Reporte:</label>
                    <select id="report_type" name="report_type" required onchange="updateFormFields()">
                    <!-- 
                    SELECT PRINCIPAL que controla todo el formulario:
                    - required: Campo obligatorio (validaci√≥n HTML5)
                    - onchange="updateFormFields()": JavaScript que muestra/oculta campos
                    - La funci√≥n est√° definida en custom_reports.js
                    -->
                        <option value="">Selecciona un tipo</option>
                        
                        <option value="inventory_general" {% if report_type == 'inventory_general' %}selected{% endif %}>Inventario General</option>
                        <!-- 
                        JINJA2 CONDICIONAL:
                        {% if report_type == 'inventory_general' %}selected{% endif %}
                        
                        Esto mantiene la selecci√≥n del usuario despu√©s de enviar el formulario.
                        Si el usuario seleccion√≥ este tipo y hay error o resultados,
                        el campo permanece seleccionado para facilitar ajustes.
                        -->
                        
                        <option value="inventory_by_category" {% if report_type == 'inventory_by_category' %}selected{% endif %}>Inventario por Categor√≠a</option>
                        <option value="low_stock" {% if report_type == 'low_stock' %}selected{% endif %}>Productos con Stock Bajo</option>
                        <option value="movements_by_period" {% if report_type == 'movements_by_period' %}selected{% endif %}>Movimientos por Per√≠odo</option>
                        <option value="value_by_provider" {% if report_type == 'value_by_provider' %}selected{% endif %}>Valor por Proveedor</option>
                    </select>
                </div>
                
                <div class="form-group date-fields" style="display: none;">
                    <!-- 
                    CAMPOS DE FECHA CONDICIONALES:
                    - class="date-fields": Permite mostrar/ocultar con JavaScript
                    - style="display: none;": Ocultos por defecto
                    - Solo se muestran para reportes que los necesiten (movimientos por per√≠odo)
                    -->
                    <label for="date_from">Fecha Desde:</label>
                    <input type="date" id="date_from" name="date_from" value="{{ filters.date_from or '' }}">
                    <!-- 
                    INPUT TYPE="DATE":
                    - HTML5: Muestra calendario autom√°ticamente
                    - value="{{ filters.date_from or '' }}": Mantiene valor despu√©s de submit
                    - Jinja2 OR operator: Si filters.date_from existe, lo usa; sino, string vac√≠o
                    -->
                </div>
                
                <div class="form-group date-fields" style="display: none;">
                    <label for="date_to">Fecha Hasta:</label>
                    <input type="date" id="date_to" name="date_to" value="{{ filters.date_to or '' }}">
                </div>
                
                <div class="form-group">
                    <label for="category">Categor√≠a:</label>
                    <select id="category" name="category">
                        <option value="">Todas las categor√≠as</option>
                        {% for cat in categories %}
                        <!-- 
                        LOOP JINJA2 PARA OPCIONES DIN√ÅMICAS:
                        Este for itera sobre la lista enviada desde Flask.
                        
                        En app.py, la funci√≥n custom_reports() ejecuta:
                        cursor.execute("SELECT DISTINCT category FROM products...")
                        categories = [row['category'] for row in cursor.fetchall()]
                        
                        Esto crea options din√°micamente basadas en datos reales.
                        -->
                        <option value="{{ cat }}" {% if filters.category == cat %}selected{% endif %}>{{ cat }}</option>
                        <!-- 
                        PRESERVACI√ìN DE SELECCI√ìN:
                        {% if filters.category == cat %}selected{% endif %}
                        Mantiene la categor√≠a seleccionada despu√©s del submit del formulario
                        -->
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="provider">Proveedor:</label>
                    <select id="provider" name="provider">
                        <option value="">Todos los proveedores</option>
                        {% for prov in providers %}
                        <!-- Similar al loop de categor√≠as, pero para proveedores -->
                        <option value="{{ prov }}" {% if filters.provider == prov %}selected{% endif %}>{{ prov }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group stock-fields" style="display: none;">
                    <!-- 
                    CAMPO DE NIVEL DE STOCK CONDICIONAL:
                    Solo se muestra para reportes de inventario general
                    Permite filtrar por stock bajo, alto, o cualquier nivel
                    -->
                    <label for="stock_level">Nivel de Stock:</label>
                    <select id="stock_level" name="stock_level">
                        <option value="">Cualquier nivel</option>
                        <option value="low" {% if filters.stock_level == 'low' %}selected{% endif %}>Stock Bajo</option>
                        <option value="high" {% if filters.stock_level == 'high' %}selected{% endif %}>Stock Alto</option>
                    </select>
                </div>
            </div>
            <!-- Fin del form-grid -->
            
            <div class="form-actions">
                <!-- Contenedor para botones de acci√≥n del formulario -->
                <button type="submit" class="btn btn-primary">
                    <span class="btn-icon">üìä</span>
                    Generar Reporte
                </button>
                <!-- 
                BOT√ìN SUBMIT:
                - type="submit": Env√≠a el formulario al endpoint generate_custom_report
                - Emoji üìä para mejorar UX visual
                - class="btn btn-primary": Estilos CSS del bot√≥n principal
                -->
            </div>
        </form>
    </div>
    
    {% if report_type and not results %}
    <!-- 
    CONDICIONAL JINJA2 COMPLEJO - ESTADO SIN RESULTADOS:
    
    Esta condici√≥n se cumple cuando:
    1. report_type existe (se ejecut√≥ una b√∫squeda)
    2. results no existe o est√° vac√≠o (no se encontraron datos)
    
    Es decir: el usuario envi√≥ el formulario pero no hay datos que mostrar.
    Esto mejora mucho la UX proporcionando feedback espec√≠fico.
    -->
    <div class="report-results-section">
        <div class="no-results-message">
            <!-- SECCI√ìN DE NO-RESULTADOS con UX mejorada -->
            <div class="no-results-icon">üìä</div>
            <h3>No se encontraron resultados</h3>
            <p>No hay datos que coincidan con los par√°metros seleccionados para el reporte de <strong>{{ report_type.replace('_', ' ').title() }}</strong>.</p>
            <!-- 
            JINJA2 FILTERS ANIDADOS:
            {{ report_type.replace('_', ' ').title() }}
            
            1. report_type.replace('_', ' '): Reemplaza _ con espacios
            2. .title(): Capitaliza cada palabra
            Ejemplo: "inventory_by_category" ‚Üí "Inventory By Category"
            -->
            
            {% if filters.date_from or filters.date_to or filters.category or filters.provider or filters.stock_level %}
            <!-- 
            CONDICIONAL PARA MOSTRAR FILTROS APLICADOS:
            Solo se muestra si al menos uno de los filtros est√° activo.
            Usa el operador OR de Jinja2 para verificar m√∫ltiples condiciones.
            -->
            <div class="applied-filters">
                <h4>Filtros aplicados:</h4>
                <div class="filter-tags">
                    <!-- TAGS VISUALES DE FILTROS APLICADOS -->
                    {% if filters.date_from %}
                        <span class="filter-tag">üìÖ Desde: {{ filters.date_from }}</span>
                    {% endif %}
                    {% if filters.date_to %}
                        <span class="filter-tag">üìÖ Hasta: {{ filters.date_to }}</span>
                    {% endif %}
                    {% if filters.category %}
                        <span class="filter-tag">üè∑Ô∏è Categor√≠a: {{ filters.category }}</span>
                    {% endif %}
                    {% if filters.provider %}
                        <span class="filter-tag">üè¢ Proveedor: {{ filters.provider }}</span>
                    {% endif %}
                    {% if filters.stock_level %}
                        <span class="filter-tag">üì¶ Stock: {{ filters.stock_level.title() }}</span>
                    {% endif %}
                    <!-- 
                    M√öLTIPLES CONDICIONALES JINJA2:
                    Cada filtro se muestra solo si tiene valor.
                    Los emojis ayudan a identificar visualmente cada tipo de filtro.
                    -->
                </div>
            </div>
            {% endif %}
            
            <div class="suggestions">
                <!-- SUGERENCIAS PARA MEJORAR LA B√öSQUEDA -->
                <h4>Sugerencias:</h4>
                <ul>
                    <li>Verifica que los filtros de fecha sean correctos</li>
                    <li>Intenta ampliar el rango de fechas</li>
                    <li>Revisa si la categor√≠a o proveedor seleccionado existe</li>
                    <li>Prueba con menos filtros para obtener m√°s resultados</li>
                </ul>
                <!-- Lista de sugerencias para ayudar al usuario a obtener resultados -->
            </div>
            
            <div class="retry-actions">
                <!-- BOTONES DE ACCI√ìN PARA REINTENTAR -->
                <button onclick="window.location.reload()" class="btn btn-secondary">
                    üîÑ Intentar de nuevo
                </button>
                <!-- 
                JAVASCRIPT INLINE:
                window.location.reload() recarga la p√°gina completa.
                √ötil para limpiar el formulario y empezar de nuevo.
                -->
                
                <a href="{{ url_for('custom_reports') }}" class="btn btn-primary">
                    üìà Nuevo reporte
                </a>
                <!-- 
                ENLACE QUE PARECE BOT√ìN:
                Navega a la misma p√°gina pero sin par√°metros,
                efectivamente reiniciando la interfaz.
                -->
            </div>
        </div>
    </div>
    
    {% elif results %}
    <!-- 
    ELIF - ESTADO CON RESULTADOS:
    Esta rama se ejecuta cuando S√ç hay resultados para mostrar.
    elif es parte del if anterior: if no results / elif results / endif
    -->
    <div class="report-results-section">
        <div class="results-header">
            <!-- HEADER DE RESULTADOS con t√≠tulo y acciones -->
            <h2>Resultados del Reporte</h2>
            <div class="export-actions">
                <form method="POST" action="{{ url_for('export_custom_report') }}" style="display: inline;">
                <!-- 
                FORMULARIO DE EXPORTACI√ìN:
                - method="POST": Env√≠o seguro
                - action="{{ url_for('export_custom_report') }}": Endpoint de exportaci√≥n
                - style="display: inline;": Para que el bot√≥n aparezca en l√≠nea con el t√≠tulo
                -->
                
                    <!-- CAMPOS OCULTOS para mantener filtros en la exportaci√≥n -->
                    <input type="hidden" name="report_type" value="{{ report_type }}">
                    <input type="hidden" name="date_from" value="{{ filters.date_from or '' }}">
                    <input type="hidden" name="date_to" value="{{ filters.date_to or '' }}">
                    <input type="hidden" name="category" value="{{ filters.category or '' }}">
                    <input type="hidden" name="provider" value="{{ filters.provider or '' }}">
                    <input type="hidden" name="stock_level" value="{{ filters.stock_level or '' }}">
                    <!-- 
                    CAMPOS HIDDEN:
                    Env√≠an exactamente los mismos filtros que se usaron para generar
                    la tabla visual, garantizando que el CSV tenga los mismos datos.
                    -->
                    
                    <button type="submit" class="btn btn-success">
                        <span class="btn-icon">üíæ</span>
                        Exportar CSV
                    </button>
                </form>
            </div>
        </div>
        
        <div class="results-summary">
            <!-- RESUMEN DE RESULTADOS con estad√≠sticas -->
            <div class="summary-card">
                <h3>{{ results|length }}</h3>
                <p>Registros encontrados</p>
                <!-- 
                FILTRO JINJA2 |length:
                Cuenta los elementos en la lista results.
                Es equivalente a len(results) en Python.
                -->
            </div>
        </div>
        
        <div class="results-table">
            <!-- TABLA DE RESULTADOS PRINCIPAL -->
            <table>
                <thead>
                    <!-- CABECERA DIN√ÅMICA seg√∫n tipo de reporte -->
                    <tr>
                        {% if report_type == 'inventory_by_category' %}
                        <!-- REPORTE AGRUPADO POR CATEGOR√çA -->
                            <th>Categor√≠a</th>
                            <th>Total Productos</th>
                            <th>Total Cantidad</th>
                            <th>Valor Total</th>
                        <!-- 
                        REPORTE AGREGADO:
                        Este tipo muestra res√∫menes por categor√≠a,
                        no productos individuales.
                        -->
                        
                        {% elif report_type == 'low_stock' %}
                        <!-- REPORTE DE STOCK BAJO -->
                            <th>Producto</th>
                            <th>Categor√≠a</th>
                            <th>Cantidad</th>
                            <th>Stock M√≠nimo</th>
                            <th>Proveedor</th>
                            <th>D√©ficit</th>
                        <!-- 
                        COLUMNAS ESPEC√çFICAS:
                        "D√©ficit" calcula cu√°ntas unidades faltan
                        para llegar al stock m√≠nimo.
                        -->
                        
                        {% elif report_type == 'movements_by_period' %}
                        <!-- REPORTE DE MOVIMIENTOS POR PER√çODO -->
                            <th>Fecha</th>
                            <th>Producto</th>
                            <th>Categor√≠a</th>
                            <th>Tipo</th>
                            <th>Cantidad</th>
                            <th>Motivo</th>
                            <th>Usuario</th>
                        <!-- 
                        INFORMACI√ìN TEMPORAL:
                        Enfocado en cambios hist√≥ricos del inventario,
                        incluyendo qui√©n hizo qu√© y cu√°ndo.
                        -->
                        
                        {% elif report_type == 'value_by_provider' %}
                        <!-- REPORTE DE VALOR POR PROVEEDOR -->
                            <th>Proveedor</th>
                            <th>Total Productos</th>
                            <th>Total Cantidad</th>
                            <th>Valor Total</th>
                        <!-- 
                        REPORTE FINANCIERO:
                        Agrupa por proveedor para an√°lisis de costos
                        y relaciones comerciales.
                        -->
                        
                        {% else %}
                        <!-- REPORTE GEN√âRICO (fallback) -->
                            <th>Producto</th>
                            <th>Categor√≠a</th>
                            <th>Cantidad</th>
                            <th>Precio</th>
                            <th>Proveedor</th>
                            <th>Stock M√≠nimo</th>
                            <th>Fecha Creaci√≥n</th>
                        <!-- 
                        ELSE COMO FALLBACK:
                        Si no coincide con ning√∫n tipo espec√≠fico,
                        muestra columnas gen√©ricas de inventario.
                        -->
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    <!-- CUERPO DE LA TABLA con datos din√°micos -->
                    {% for row in results %}
                    <!-- 
                    LOOP FOR EN JINJA2:
                    Itera sobre cada registro en results.
                    'row' representa un registro individual.
                    -->
                    <tr>
                        {% if report_type == 'inventory_by_category' %}
                        <!-- DATOS PARA REPORTE POR CATEGOR√çA -->
                            <td>{{ row.category }}</td>
                            <td>{{ row.total_products }}</td>
                            <td>{{ row.total_quantity }}</td>
                            <td>${{ "%.2f"|format(row.total_value) }}</td>
                        <!-- 
                        FORMATEO DE N√öMEROS:
                        "%.2f"|format() es un filtro que formatea n√∫meros
                        con 2 decimales, similar a format() en Python.
                        -->
                        
                        {% elif report_type == 'low_stock' %}
                        <!-- DATOS PARA REPORTE DE STOCK BAJO -->
                            <td>{{ row.name }}</td>
                            <td>{{ row.category }}</td>
                            <td class="low-stock">{{ row.quantity }}</td>
                            <!-- 
                            CLASE CSS ESPEC√çFICA:
                            "low-stock" aplica estilos visuales para
                            destacar productos con stock bajo.
                            -->
                            <td>{{ row.stock_min }}</td>
                            <td>{{ row.provider }}</td>
                            <td class="deficit">{{ row.deficit }}</td>
                            <!-- 
                            CAMPO CALCULADO:
                            'deficit' viene pre-calculado desde el backend,
                            evitando c√°lculos complejos en el template.
                            -->
                        
                        {% elif report_type == 'movements_by_period' %}
                        <!-- DATOS PARA REPORTE DE MOVIMIENTOS -->
                            <td>{{ row.created_at[:10] }}</td>
                            <!-- 
                            SLICE DE STRING:
                            [:10] toma los primeros 10 caracteres de la fecha,
                            efectivamente mostrando solo YYYY-MM-DD.
                            -->
                            <td>{{ row.product_name }}</td>
                            <td>{{ row.category }}</td>
                            <td>
                                <span class="movement-type movement-{{ row.movement_type }}">
                                    {{ row.movement_type.title() }}
                                </span>
                                <!-- 
                                CLASES CSS DIN√ÅMICAS:
                                "movement-{{ row.movement_type }}" genera clases como:
                                - movement-entrada
                                - movement-salida
                                .title() capitaliza la primera letra.
                                -->
                            </td>
                            <td>{{ row.quantity }}</td>
                            <td>{{ row.reason }}</td>
                            <td>{{ row.username }}</td>
                        
                        {% elif report_type == 'value_by_provider' %}
                        <!-- DATOS PARA REPORTE POR PROVEEDOR -->
                            <td>{{ row.provider }}</td>
                            <td>{{ row.total_products }}</td>
                            <td>{{ row.total_quantity }}</td>
                            <td>${{ "%.2f"|format(row.total_value) }}</td>
                        
                        {% else %}
                        <!-- DATOS PARA REPORTE GEN√âRICO -->
                            <td>{{ row.name }}</td>
                            <td>{{ row.category }}</td>
                            <td>{{ row.quantity }}</td>
                            <td>${{ "%.2f"|format(row.price) }}</td>
                            <td>{{ row.provider }}</td>
                            <td>{{ row.stock_min }}</td>
                            <td>{{ row.created_at[:10] }}</td>
                            <!-- 
                            FORMATO CONSISTENTE:
                            Mismo slice [:10] para fechas en formato consistente.
                            -->
                        {% endif %}
                    </tr>
                    {% endfor %}
                    <!-- 
                    ENDFOR:
                    Marca el final del bucle for.
                    Cada iteraci√≥n genera una fila <tr> completa.
                    -->
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
    <!-- 
    ENDIF PRINCIPAL:
    Cierra la estructura condicional que maneja:
    - Condicional sin resultados despu√©s de POST (sin resultados)
    - Condicional con resultados (con resultados)
    - (sin else, porque si no hay POST no se muestra nada)
    -->
</div>

<!-- CARGA DE JAVASCRIPT ESPEC√çFICO -->
<script src="{{ url_for('static', filename='js/custom_reports.js') }}"></script>
<!-- 
URL_FOR PARA ARCHIVOS EST√ÅTICOS:
Genera la URL correcta para archivos en /static/js/
Flask maneja autom√°ticamente la ruta y versionado.
-->
{% endblock %}
<!-- 
ENDBLOCK:
Cierra el bloque 'content' que se defini√≥ al inicio.
Este contenido se insertar√° en layout.html donde est√© el bloque content correspondiente.
-->
